<form id="carForm">
    <div id="carList">
        <div class="car-entry">
            <label for="brand">Velg bilmerke:</label>
            <select class="brand" name="brand">
                <option value="">Velg...</option>
            </select>

            <label for="model">Velg modell:</label>
            <select class="model" name="model">
                <option value="">Velg et bilmerke først...</option>
            </select>

            <label for="year">Velg årsmodell:</label>
            <select class="year" name="year">
                <option value="">Velg en modell først...</option>
            </select>

            <button type="button" class="removeCar">Fjern bil</button>
        </div>
    </div>

    <button type="button" id="addCar">Legg til en bil</button>

    <label for="email">E-postadresse:</label>
    <input type="email" id="email" name="email" placeholder="Din e-post" required>

    <button type="submit">Send inn</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var brandModelYearMap = {}; // Store brands -> models -> years

    // Fetch CSV file from GitHub
    fetch("https://raw.githubusercontent.com/bruktbilanalytics/used-car-form/main/brand_model_year.csv")
        .then(response => response.text())
        .then(data => {
            let rows = data.split("\n").map(row => row.trim()).filter(row => row);
            rows.shift(); // Remove header row

            rows.forEach(row => {
                let [brand, model, year] = row.split(",");

                if (!brandModelYearMap[brand]) {
                    brandModelYearMap[brand] = {};
                }
                if (!brandModelYearMap[brand][model]) {
                    brandModelYearMap[brand][model] = new Set();
                }
                brandModelYearMap[brand][model].add(year);
            });

            function updateDropdowns(container) {
                let brandDropdown = container.querySelector(".brand");
                let modelDropdown = container.querySelector(".model");
                let yearDropdown = container.querySelector(".year");

                // Populate brands
                brandDropdown.innerHTML = "<option value=''>Velg...</option>";
                Object.keys(brandModelYearMap).forEach(brand => {
                    let option = document.createElement("option");
                    option.value = brand;
                    option.textContent = brand;
                    brandDropdown.appendChild(option);
                });

                brandDropdown.addEventListener("change", function () {
                    let selectedBrand = brandDropdown.value;
                    modelDropdown.innerHTML = "<option value=''>Velg...</option>";
                    yearDropdown.innerHTML = "<option value=''>Velg en modell først...</option>";

                    if (brandModelYearMap[selectedBrand]) {
                        Object.keys(brandModelYearMap[selectedBrand]).forEach(model => {
                            let option = document.createElement("option");
                            option.value = model;
                            option.textContent = model;
                            modelDropdown.appendChild(option);
                        });
                    }
                });

                modelDropdown.addEventListener("change", function () {
                    let selectedBrand = brandDropdown.value;
                    let selectedModel = modelDropdown.value;
                    yearDropdown.innerHTML = "<option value=''>Velg...</option>";

                    if (brandModelYearMap[selectedBrand] && brandModelYearMap[selectedBrand][selectedModel]) {
                        brandModelYearMap[selectedBrand][selectedModel].forEach(year => {
                            let option = document.createElement("option");
                            option.value = year;
                            option.textContent = year;
                            yearDropdown.appendChild(option);
                        });
                    }
                });
            }

            document.querySelectorAll(".car-entry").forEach(updateDropdowns);
        })
        .catch(error => console.error("Error loading CSV:", error));

    document.getElementById("addCar").addEventListener("click", function () {
        let carList = document.getElementById("carList");
        let newEntry = document.createElement("div");
        newEntry.classList.add("car-entry");
        newEntry.innerHTML = `
            <label for="brand">Velg bilmerke:</label>
            <select class="brand" name="brand">
                <option value="">Velg...</option>
            </select>

            <label for="model">Velg modell:</label>
            <select class="model" name="model">
                <option value="">Velg et bilmerke først...</option>
            </select>

            <label for="year">Velg årsmodell:</label>
            <select class="year" name="year">
                <option value="">Velg en modell først...</option>
            </select>

            <button type="button" class="removeCar">Fjern bil</button>
        `;
        carList.appendChild(newEntry);
        updateDropdowns(newEntry);
    });

    document.getElementById("carList").addEventListener("click", function (e) {
        if (e.target.classList.contains("removeCar")) {
            e.target.parentElement.remove();
        }
    });

    document.getElementById("carForm").addEventListener("submit", function (e) {
        e.preventDefault();

        let carEntries = document.querySelectorAll(".car-entry");
        let formData = new FormData();
        let email = document.getElementById("email").value;
        formData.append("email", email);

        carEntries.forEach((entry, index) => {
            let brand = entry.querySelector(".brand").value;
            let model = entry.querySelector(".model").value;
            let year = entry.querySelector(".year").value;

            formData.append(`brand_${index}`, brand);
            formData.append(`model_${index}`, model);
            formData.append(`year_${index}`, year);
        });

        fetch("https://script.google.com/macros/s/AKfycbwhNMgxvtpuomB6GayNuVAcTe3II_aOPZBgbOIYfmXlF23QhgCJkw3bMJQu3bZ80QJYKA/exec", {
            method: "POST",
            body: new URLSearchParams(formData),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        })
        .then(response => response.text())
        .then(data => {
            alert("Dine biler er sendt inn!");
            document.getElementById("carForm").reset();
        })
        .catch(error => {
            alert("Noe gikk galt. Prøv igjen.");
            console.error(error);
        });
    });
});
</script>
